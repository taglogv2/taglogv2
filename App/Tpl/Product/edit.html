<!DOCTYPE html>
<html lang="zh-cn">
<head>

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="Public/css/bootstrap/css/bootstrap.min.css"/>
<link rel="stylesheet" href="Public/css/jquery-ui-1.10.0.custom.css"/>
<link rel="stylesheet" href="Public/css/font-awesome/css/font-awesome.min.css" />
<link rel="stylesheet" href="Public/js/summernote/summernote.css"/>
<link rel="stylesheet" href="Public/js/colpick/css/colpick.css" />
<link rel="stylesheet" href="Public/css/style.css"/>

<link rel="stylesheet" href="Public/css/custom/yhb_grid_system.css"/>
<link rel="stylesheet" href="Public/css/custom/yhb_single_image.css"/>
<link rel="stylesheet" href="Public/css/custom/yhb_style.css"/>

<title>我的说明书 - 说明书编辑</title>
</head>


<body class="edit-builder">

	<!-- hidden modals -->
	<!-- Modal -->
	<div class="modal fade" id="resource-panel" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
		<div class="modal-content">
		  <div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			<h4 class="modal-title" id="myModalLabel">resource controller:</h4>
		  </div>
		  <div class="modal-body">
			<input type="text" class="form-control" id="url-input-id" placeholder="">
		  </div>
		  <div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">cancel</button>
			<button type="button" class="btn btn-primary" id="confirm-id">confirm</button>
		  </div>
		</div><!-- /.modal-content -->
	  </div><!-- /.modal-dialog -->
	</div><!-- /.modal -->



	<include file="Public:head"/>
	<!-- left-navigator -->
	<div class="left-nav">
			<a class="left-nav-slider" id="add-page-btn">
				<span class="left-nav-icon"><i class="glyphicon glyphicon-plus"></i></span>
				<span class="left-nav-text">新建一页</span>
			</a>
		<!--page indexs the hover effect bug need to be fixed -->
		<div id="left-nav-pages">
					<a class="left-nav-slider">
						<span class="left-nav-icon"><i class="glyphicon glyphicon-file"></i></span>
						<span class="left-nav-text">第1页</span>
					</a>
					<a class="left-nav-slider">
						<span class="left-nav-icon"><i class="glyphicon glyphicon-file"></i></span>
						<span class="left-nav-text">第2页</span>
					</a>
					<a class="left-nav-slider">
						<span class="left-nav-icon"><i class="glyphicon glyphicon-file"></i></span>
						<span class="left-nav-text">第3页</span>
					</a>
		</div>

		<div class="left-nav-controls">
			<a class="left-nav-slider" id="save">
				<input type="hidden" name="product_id" value="{$product.product_id}">
				<span class="left-nav-icon"><i class="glyphicon glyphicon-floppy-disk"></i></span>
				<span class="left-nav-text">保存</span>
			</a>
			<a class="left-nav-slider">
				<span class="left-nav-icon"><i class="glyphicon glyphicon-ok"></i></span>
				<span class="left-nav-text">生成二维码</span>
			</a>
		</div>
		
	</div>
	<!-- end -->
	<!-- st edit-wrapper -->
	<div class="edit-wrapper">
		<!-- left column of the preview section -->
		<div class="half-col canvas-wrapper">
			<div class="canvas-board" id="135">
				<div class="grid-system" id="canvas">
				</div> 
			</div>
		</div>

		<!-- right column of the editor -->
		<div class="half-col editor-wrapper">
			<div class="editor-board">
				<div class="editor-head">
					<!-- tab-navigator -->
					<ul id="editor-tab" role="tablist">
					    <li><a href="#edit-page" role="tab" data-toggle="tab">编辑页面</a></li>
					    <li class="active"><a href="#add-component" role="tab" data-toggle="tab">添加组件</a></li>
					    <!--NOTICE, there is a must span to enable this correctly-->
					    <li><a href="#edit-component" role="tab" data-toggle="tab" id="editor-edit-id">编辑组件</a></li>
					</ul>
				</div>

				<div class="editor-content tab-content">
					<div class="tab-pane fade" id="edit-page">
					</div>

					<div class="tab-pane fade in active" id="add-component">
					 	<div class="edit-group">
					 		<div class="edit-group-title">点击或拖拽添加组件</div>
					  		<div class="editor-add-cmp">
							 	<ul>
							  		<li>
							  			<div id="utility-text">文本框</div>
							  		</li>
							  		<li>
							  			<div id="utility-image">图片</div>
							  		</li>
							  		<li>
							  			<div id="utility-video">视频</div>
							  		</li>
							 	</ul>
							</div>	
					 	</div>
					</div>

					<div class="tab-pane fade" id="edit-component">

					</div>
  		

				</div>
			</div>
		</div>
	</div>


	<div id="debug_log_window" style="position:fixed; right:30px; bottom:30px; width:40%; height:40px">
		
	</div>




	<script type="text/javascript" src="Public/js/jquery-1.9.0.min.js"></script>
	<script type="text/javascript" src="Public/js/jquery-ui-1.10.0.custom.min.js"></script>
	<script type="text/javascript" src="Public/css/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="Public/js/nicescroll/jquery.nicescroll.min.js"></script>
	<script type="text/javascript" src="Public/js/summernote/summernote.js"></script>
	<script type="text/javascript" src="Public/js/colpick/js/colpick.js"></script>
	<script type="text/javascript" src="Public/js/edit.js"></script>

	<script type="text/javascript" src="Public/js/custom/yhb_canvas.js"></script>
	<script type="text/javascript" src="Public/js/custom/yhb_single_image.js"></script>
	<script type="text/javascript" src="Public/js/custom/yhb_utility.js"></script>
	<script type="text/javascript" src="Public/js/custom/yhb_common_functions.js"></script>

	<script type="text/javascript">
		$(document).ready(function() {

			/* get window size, initial and resize */
			YHB = {};
			YHB.canvasWidth = $('.canvas-board').width();
			YHB.gridNumber = 16;
			YHB.gridSize = YHB.canvasWidth/YHB.gridNumber;

			//YHB.currentProductId = $("#save input").val();
			YHB.currentProductId = "3"; // 测试用
			YHB.currentProductName = "测试";
			YHB.currentPage = "135"; // 此值保存每个页面在数据库中的id
			//YHB.needToSave = {};
			YHB.pluginInstanceArray = {};
			YHB.currentComId = false;
			YHB.previousComId = false;
			//alert($('.canvas-board').height());
			//alert($('#canvas').height());

			/* basic plugin init */
	  		YHB.comCount = (function () {
				var count = 0;
				return {
					getCount: function () {
						return count;
					},
					setCount: function (newCount) {
						count = newCount;
					},
					incCount: function () {
						count++;
					}
				};
			})();
	  		

			/* 2. set left-nav-pages sortable */
			$('#left-nav-pages').sortable();


			/* 3. canvas window */
			initGridSystem();
			$("#canvas").yhb_canvas({
				callback:debug_log
			});

			/* 4. utilities window */
			$("#utility-image").yhb_utility({
				componentName: "yhb_single_image",
				canvasID: "canvas",
				editorId:"editor-edit-id",
				resourcePanelId: "resource-panel",
				widthInGrid: "4",
				heightInGrid: "3",
				callback:debug_log
			});


			$('.canvas-board').niceScroll({
				cursorwidth:8,
				cursoropacitymax : 0.5,
				horizrailenabled : false
			});

	  		$('.editor-content').niceScroll({cursorwidth:8});


		});



		$(window).resize(function() {
			// TODO:
  			// YHB.gridSize = $(document).width()/YHB.gridNumber;
		});


		/*
		和后台交互的json数据格式
		{
		    "productname": "说明书标题", 
		    "producttype": "说明书种类", 
		    "productid": "产品id(唯一&和数据库同步)",
		    "pages": [
		        {
		            "pagetitle": "页名字", 
		            "pagesort": "页编号0", 
		            "pageid": "页面id(唯一&和数据库同步)"
		            "content": "<div>...</div>"
		        }...
		    ]
		}*/

		/*
		原子操作类型:
		增加[页面|组件] 			-> 返回 [页面|组件]id
		更新[页面|组件]中的属性 	-> 返回 成功 or 失败
		删除[页面|组件] 			-> 返回 成功 or 失败 
		{
		    "actions": [
		        {
		            "A": "Insert_Delete_Update",
		            "O": "product_page_component",
		            "Id": "comId",
		            "Key": "title_type_content",
		            "Val": "the content"
		        }
		    ]
		}
		*/

		$("#save").on("click", function(){
			var toUploadJSON = {};
			toUploadJSON.productname = YHB.currentProductName;
			toUploadJSON.productid = YHB.currentProductId;
			toUploadJSON.pages = [];

			var postUrl = '{:U('product/edit','product_id='.$product['product_id'])}';
			var savedPages = {};
			for(key in YHB.pluginInstanceArray) {
				val = YHB.pluginInstanceArray[key];
				if(!val.saved() && !savedPages[val.pageId()]) {
					savedPages[val.pageId()] = true;
					var tmpstr = "";
					//alert($("#"+val.pageId()).html());
					$("#"+val.pageId()).find(".component").each(function(index){
						//alert(YHB.pluginInstanceArray[$(this).attr("id")].html());
						//alert($(this).outerHTML());
						tmpstr += YHB.pluginInstanceArray[$(this).attr("id")].html();	
						//alert(tmpstr);			
						
					});
					var pageJSON = {};
					pageJSON.pageid = val.pageId();
					pageJSON.content = tmpstr;
					//alert(JSON.stringify(pageJSON));
					toUploadJSON.pages.push(pageJSON);
				} else if(!val.saved() && savedPages[val.pageId()]) {
					val.saved(true);
				}
			}
			alert(JSON.stringify(toUploadJSON));
			$.post(postUrl, JSON.stringify(toUploadJSON), function(data){
				alert("success");
			}).fail(function() {
				alert("failed");
			});
			
		});

	</script>
</body>
</html>
